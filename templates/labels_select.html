{% extends "base.html" %}
{# Hide footer on labels page #}
{% block footer %}{% endblock %}

{% block content %}

<section class="panel">
    <h2>Print Labels</h2>

    <form method="post" action="/print/labels" class="labels-select" id="label-form">

        <!-- Container Labels Section -->
        <fieldset id="containers-fieldset">
            <legend>
                <label class="radio section-toggle">
                    <input type="radio" name="label_type" value="container" checked>
                    Container Labels
                </label>
            </legend>

            <div class="section-content" id="containers-content">
                {% for c in containers %}
                <div class="label-row">
                    <label class="checkbox">
                        <input type="checkbox" name="code" value="{{ c }}">
                        <span class="mono">{{ c }}</span>
                    </label>

                    <input type="text" name="text_{{ c }}" placeholder="Optional text (for combined/content modes)"
                        class="labeltext" />
                </div>
                {% endfor %}
            </div>
        </fieldset>

        <!-- Part Labels Section -->
        <fieldset id="parts-fieldset" class="disabled-section">
            <legend>
                <label class="radio section-toggle">
                    <input type="radio" name="label_type" value="part">
                    Part Labels
                </label>
            </legend>

            <div class="section-content" id="parts-content">
                <div class="parts-filters">
                    <input type="text" name="parts_q" id="parts-q" placeholder="Search parts...">
                    <select name="parts_category" id="parts-category">
                        <option value="">All categories</option>
                        {% for cat in categories %}
                        <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                    <select name="parts_container" id="parts-container">
                        <option value="">All containers</option>
                        {% for c in containers %}
                        <option value="{{ c }}">{{ c }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="btn btn-small" id="parts-filter-btn">Filter</button>
                </div>

                <div class="parts-list" id="parts-list">
                    <div class="muted">Use filters above to find parts</div>
                </div>
            </div>
        </fieldset>

        <fieldset class="label-format">
            <legend>Label format</legend>

            <select name="preset" required id="preset-select">
                {% for p in presets %}
                <option value="{{ p }}"
                    data-columns="{{ preset_meta.get(p, {}).get('columns', '?') }}"
                    data-rows="{{ preset_meta.get(p, {}).get('rows', '?') }}"
                    data-size="{{ preset_meta.get(p, {}).get('label_size', '?') }}">{{ p }}</option>
                {% endfor %}
            </select>
            <span class="preset-info muted" id="preset-info"></span>

            <select name="mode" required id="mode-select">
                <!-- Populated by JS based on label_type -->
            </select>

            <label class="start-position">
                <span>Start at position</span>
                <input type="number" name="start_position" value="1" min="1" max="100" id="start-position" />
                <span class="muted" id="position-hint">(skip used labels)</span>
            </label>

            <label class="checkbox outline-toggle">
                <input type="checkbox" name="outline" value="1" id="outline">
                <span>Print cut outlines</span>
                <span class="muted">(always shown on screen; printed only when enabled)</span>
            </label>
        </fieldset>

        <div class="actions">
            <button class="btn" type="submit" id="print-btn" disabled>Print selected</button>
        </div>

    </form>
</section>

<script>
    (() => {
        const form = document.getElementById("label-form");
        const btn = document.getElementById("print-btn");
        const preset = form?.querySelector('select[name="preset"]');
        const modeSelect = document.getElementById("mode-select");
        const outline = form?.querySelector('input[name="outline"]');
        const startPos = form?.querySelector('input[name="start_position"]');
        const presetInfo = document.getElementById("preset-info");
        const positionHint = document.getElementById("position-hint");

        const labelTypeRadios = form?.querySelectorAll('input[name="label_type"]');
        const containersFieldset = document.getElementById("containers-fieldset");
        const partsFieldset = document.getElementById("parts-fieldset");
        const containersContent = document.getElementById("containers-content");
        const partsContent = document.getElementById("parts-content");
        const partsList = document.getElementById("parts-list");

        // Parts filter elements
        const partsQ = document.getElementById("parts-q");
        const partsCat = document.getElementById("parts-category");
        const partsCont = document.getElementById("parts-container");
        const partsFilterBtn = document.getElementById("parts-filter-btn");

        if (!form || !btn) return;

        const KEY = "labels.print.settings";

        // Mode options
        const containerModes = [
            {% for v, label in container_modes %}
            { value: "{{ v }}", label: "{{ label }}" },
            {% endfor %}
        ];
        const partModes = [
            {% for v, label in part_modes %}
            { value: "{{ v }}", label: "{{ label }}" },
            {% endfor %}
        ];

        const populateModes = (modes) => {
            modeSelect.innerHTML = "";
            modes.forEach(m => {
                const opt = document.createElement("option");
                opt.value = m.value;
                opt.textContent = m.label;
                modeSelect.appendChild(opt);
            });
        };

        const updatePresetInfo = () => {
            if (!preset || !presetInfo) return;
            const opt = preset.options[preset.selectedIndex];
            const cols = opt?.dataset.columns || "?";
            const rows = opt?.dataset.rows || "?";
            const size = opt?.dataset.size || "?";
            presetInfo.textContent = `(${cols}×${rows} = ${cols * rows} labels, ${size})`;

            if (positionHint && cols !== "?") {
                positionHint.textContent = `(${cols} per row, left→right)`;
            }
        };

        const getLabelType = () => {
            const checked = form.querySelector('input[name="label_type"]:checked');
            return checked?.value || "container";
        };

        const updateSections = () => {
            const type = getLabelType();
            if (type === "container") {
                containersFieldset.classList.remove("disabled-section");
                partsFieldset.classList.add("disabled-section");
                containersContent.querySelectorAll("input").forEach(el => el.disabled = false);
                partsContent.querySelectorAll("input, select, button").forEach(el => el.disabled = true);
                populateModes(containerModes);
            } else {
                containersFieldset.classList.add("disabled-section");
                partsFieldset.classList.remove("disabled-section");
                containersContent.querySelectorAll("input").forEach(el => el.disabled = true);
                partsContent.querySelectorAll("input, select, button").forEach(el => el.disabled = false);
                populateModes(partModes);
            }
            updateButtonState();
        };

        const updateButtonState = () => {
            const type = getLabelType();
            if (type === "container") {
                btn.disabled = form.querySelectorAll('input[name="code"]:checked').length === 0;
            } else {
                btn.disabled = form.querySelectorAll('input[name="part_uuid[]"]:checked').length === 0;
            }
        };

        const loadSettings = () => {
            try {
                const raw = localStorage.getItem(KEY);
                if (!raw) return;
                const s = JSON.parse(raw);
                if (preset && typeof s?.preset === "string") preset.value = s.preset;
                if (outline && typeof s?.outline === "boolean") outline.checked = s.outline;
            } catch {
                // ignore
            }
        };

        const saveSettings = () => {
            try {
                localStorage.setItem(
                    KEY,
                    JSON.stringify({
                        preset: preset?.value || "",
                        outline: !!outline?.checked,
                    })
                );
            } catch {
                // ignore
            }
        };

        // Parts filter functionality
        const filterParts = () => {
            const q = partsQ.value.trim();
            const cat = partsCat.value;
            const cont = partsCont.value;

            if (!q && !cat && !cont) {
                partsList.innerHTML = '<div class="muted">Use filters above to find parts</div>';
                return;
            }

            const params = new URLSearchParams();
            if (q) params.set("q", q);
            if (cat) params.set("category", cat);
            if (cont) params.set("container_id", cont);

            partsList.innerHTML = '<div class="muted">Loading...</div>';

            fetch(`/labels/parts?${params.toString()}`)
                .then(r => r.text())
                .then(html => {
                    partsList.innerHTML = html;
                    updateButtonState();
                })
                .catch(() => {
                    partsList.innerHTML = '<div class="error">Error loading parts</div>';
                });
        };

        // Event listeners
        labelTypeRadios.forEach(radio => {
            radio.addEventListener("change", updateSections);
        });

        form.addEventListener("change", (e) => {
            if (e.target.matches('input[name="code"]') || e.target.matches('input[name="part_uuid[]"]')) {
                updateButtonState();
            }
            if (e.target === preset || e.target === outline || e.target === startPos) {
                saveSettings();
            }
            if (e.target === preset) {
                updatePresetInfo();
            }
        });

        partsFilterBtn.addEventListener("click", filterParts);

        // Allow Enter in search field
        partsQ.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                filterParts();
            }
        });

        // Initialize
        loadSettings();
        updatePresetInfo();
        updateSections();
    })();
</script>


{% endblock %}