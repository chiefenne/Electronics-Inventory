{% extends "base.html" %}
{# Hide footer on labels page #}
{% block footer %}{% endblock %}

{% block content %}

<section class="panel">
    <h2>Print Labels</h2>

    <form method="post" action="/print/labels" class="labels-select" id="label-form">

        <fieldset>
            <legend>Containers</legend>

            {% for c in containers %}
            <div class="label-row">
                <label class="checkbox">
                    <input type="checkbox" name="code" value="{{ c }}">
                    <span class="mono">{{ c }}</span>
                </label>

                <input type="text" name="text_{{ c }}" placeholder="Optional text (for combined/content modes)"
                    class="labeltext" />
            </div>
            {% endfor %}
        </fieldset>

        <fieldset class="label-format">
            <legend>Label format</legend>

            <select name="preset" required id="preset-select">
                {% for p in presets %}
                <option value="{{ p }}"
                    data-columns="{{ preset_meta.get(p, {}).get('columns', '?') }}"
                    data-rows="{{ preset_meta.get(p, {}).get('rows', '?') }}"
                    data-size="{{ preset_meta.get(p, {}).get('label_size', '?') }}">{{ p }}</option>
                {% endfor %}
            </select>
            <span class="preset-info muted" id="preset-info"></span>

            <select name="mode" required>
                {% for v, label in modes %}
                <option value="{{ v }}">{{ label }}</option>
                {% endfor %}
            </select>

            <label class="start-position">
                <span>Start at position</span>
                <input type="number" name="start_position" value="1" min="1" max="100" id="start-position" />
                <span class="muted" id="position-hint">(skip used labels)</span>
            </label>

            <label class="checkbox outline-toggle">
                <input type="checkbox" name="outline" value="1" id="outline">
                <span>Print cut outlines</span>
                <span class="muted">(always shown on screen; printed only when enabled)</span>
            </label>
        </fieldset>

        <div class="actions">
            <button class="btn" type="submit" id="print-btn" disabled>Print selected</button>
        </div>

    </form>
</section>

<script>
    (() => {
        const form = document.getElementById("label-form");
        const btn = document.getElementById("print-btn");
        const preset = form?.querySelector('select[name="preset"]');
        const mode = form?.querySelector('select[name="mode"]');
        const outline = form?.querySelector('input[name="outline"]');
        const startPos = form?.querySelector('input[name="start_position"]');
        const presetInfo = document.getElementById("preset-info");
        const positionHint = document.getElementById("position-hint");
        if (!form || !btn) return;

        const KEY = "labels.print.settings";

        const updatePresetInfo = () => {
            if (!preset || !presetInfo) return;
            const opt = preset.options[preset.selectedIndex];
            const cols = opt?.dataset.columns || "?";
            const rows = opt?.dataset.rows || "?";
            const size = opt?.dataset.size || "?";
            presetInfo.textContent = `(${cols}×${rows} = ${cols * rows} labels, ${size})`;

            // Update position hint with column info
            if (positionHint && cols !== "?") {
                positionHint.textContent = `(${cols} per row, left→right)`;
            }
        };

        const loadSettings = () => {
            try {
                const raw = localStorage.getItem(KEY);
                if (!raw) return;
                const s = JSON.parse(raw);
                if (preset && typeof s?.preset === "string") preset.value = s.preset;
                if (mode && typeof s?.mode === "string") mode.value = s.mode;
                if (outline && typeof s?.outline === "boolean") outline.checked = s.outline;
                // Don't restore start_position - user should set it fresh each time
            } catch {
                // ignore
            }
        };

        const saveSettings = () => {
            try {
                localStorage.setItem(
                    KEY,
                    JSON.stringify({
                        preset: preset?.value || "",
                        mode: mode?.value || "",
                        outline: !!outline?.checked,
                    })
                );
            } catch {
                // ignore
            }
        };

        const update = () => {
            btn.disabled = form.querySelectorAll('input[name="code"]:checked').length === 0;
        };

        form.addEventListener("change", (e) => {
            if (e.target && e.target.matches('input[name="code"]')) update();
            if (e.target && (e.target === preset || e.target === mode || e.target === outline || e.target === startPos)) saveSettings();
            if (e.target === preset) updatePresetInfo();
        });

        loadSettings();
        updatePresetInfo();
        update();
    })();
</script>


{% endblock %}